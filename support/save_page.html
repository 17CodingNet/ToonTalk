<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<head>
<script src="../toontalk.js?no_need_to_load_css=1"></script>
<script>
function authorize_then_inform_parent_to_save_edits() {
    "use strict";
    var callback_when_authorized = function (error) {
        var file_id_index, file_id;
        if (typeof error === 'string') {
            window.parent.postMessage({authorization_problem: error,
                                       respond_to: window.location.href},
                                      "*");
            return;
        }
        file_id_index = window.location.href.indexOf("id=");
        if (file_id_index < 0) {
            console.error(window.location.href + " expected to end with id=...");
            return;
        }
        file_id = window.location.href.substring(file_id_index+3);
        window.parent.postMessage({save_edits_to: window.location.href,
                                   file_id: file_id},
                                  "*");
    };
    window.TOONTALK.google_drive.handle_client_load(callback_when_authorized);
};
var message_handler =
    function (event) {
        if (event.data === "user wants to authorize") {
            window.TOONTALK.google_drive.authorize(authorize_then_inform_parent_to_save_edits);
        }
    };
window.addEventListener("message", message_handler, false);
window.addEventListener('toontalk_initialized', function () {
    var script = document.createElement("script");
    script.src = "https://apis.google.com/js/client.js?onload=authorize_then_inform_parent_to_save_edits";
    // delay this since other listeners to toontalk_initialized may not have run yet
    setTimeout(function () {
        document.head.appendChild(script);
    });
});                                               
</script>
<title>ToonTalk hidden iframe for saving edits</title>
</head>
<body>
</body>
</html>
