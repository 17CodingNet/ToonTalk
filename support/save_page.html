<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<head>
<script src="../toontalk.js?no_need_to_load_css=1&debugging=1"></script>
<script>
function authorize_then_inform_parent_to_save_edits() {
    "use strict";
    var callback_when_authorized = function (error) {
        var file_id_index, file_id;
        if (typeof error === 'string') {
            console.error("authorize_then_inform_parent_to_save_edits received an error: " + error);
            window.parent.postMessage({authorization_problem: error,
                                       respond_to: window.location.href},
                                      "*");
            return;
        }
        file_id_index = window.location.href.indexOf("id=");
        if (file_id_index < 0) {
            console.error(window.location.href + " expected to end with id=...");
            return;
        }
        file_id = window.location.href.substring(file_id_index+3);
        console.log("Posting message to parent to start the saving of edits.");
        window.parent.postMessage({save_edits_to: window.location.href,
                                   file_id: file_id},
                                  "*");
    };
    window.TOONTALK.google_drive.handle_client_load(callback_when_authorized);
};
var message_handler =
    function (event) {
        if (event.data === "user wants to authorize") {
            window.TOONTALK.google_drive.authorize(authorize_then_inform_parent_to_save_edits);
        }
    };
window.addEventListener("message", message_handler, false);
document.addEventListener('toontalk_initialized', function () {
    var script = document.createElement("script");
    script.src = "https://apis.google.com/js/client.js"; // ?onload=authorize_then_inform_parent_to_save_edits";
    document.head.appendChild(script);
    script.addEventListener('load', function () {
        // not clear why onload didn't always call the following
        authorize_then_inform_parent_to_save_edits();
    });
    script.addEventListener('error', function (event) {
        console.error("Error loading " + script.src);
        console.error(event);
    });
});
</script>
<title>ToonTalk hidden iframe for saving edits</title>
</head>
<body>
</body>
</html>
